@model ThaiSonBacDMS.Areas.PhanPhoi.Models.ChiTietNoCungCapModel

@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/PhanPhoi/Views/Shared/_Layout1.cshtml";
}

<style>
    #example1 {
        background-color: rgb(240, 240, 240);
    }

        #example1 thead tr th {
            vertical-align: middle !important;
            text-align: center;
            background-color: #3c8dbc;
            color: #fff;
        }

    tfoot {
        color: white;
        text-align: center;
        font-size: 15px;
        font-weight: bold;
        background-color: #544d61;
    }

    .right {
        text-align: right;
    }

    #btnThanhToan:hover {
        color: black !important;
    }

    .modal-header {
        padding: 15px;
        border-bottom: 1px solid #e5e5e5;
        background-color: aliceblue;
    }

    .modal-body {
        position: relative;
        padding: 15px;
        background-color: white;
    }

    .modal-footer {
        border-top-color: #f4f4f4;
        background-color: white;
    }

    .menu-button {
        background-color: #fcf9f9;
        margin-top: 20px;
        padding-top: 20px;
        padding-right: 25px;
    }
</style>
<section class="content-header">
    <ol class="breadcrumb">
        <li>
            <a href="phanphoi_index.html">
                <i class="fa fa-dashboard"></i> Trang Chủ
            </a>
        </li>
        <li><a>Công nợ</a></li>
        <li><a href="phanphoi_congno_danh-sach-cong-no-khach-hang.html">Công nợ nhà cung cấp</a></li>
        <li><a href="phanphoi_congno_chi-tiet-no-khach-hang.html">Chi tiết</a></li>
    </ol>
</section>
@using (Html.BeginForm())
{
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box">
                    <div class="box-header" style="margin-top:10px;margin-bottom: -5px">
                        <h4 class="box-title">
                            <b>Tên Nhà Cung Cấp : @Model.supplierName.ToUpper()</b>
                            <span id="hidden">@Model.supplierId</span>
                        </h4>
                    </div>

                    <div class="box">
                        <div class="box-header with-border text-center menu-button">
                            <a href="accountant_notification.html" class="btn btn-app custom-btn disabled" title="Tạo Mới" data-placement="bottom">
                                <i class="fa fa-plus-square  text-grey"></i>
                                <span><strong>Tạo Mới</strong></span>
                            </a>
                            <a class="btn btn-app custom-btn disabled" data-toggle="tooltip" title="Sửa" data-placement="bottom">
                                <i class="fa fa-edit text-grey"></i>
                                <span><strong>Sửa</strong></span>
                            </a>
                            <a class="btn btn-app custom-btn disabled" data-toggle="tooltip" title="Lưu" data-placement="bottom">
                                <i class="fa fa-save text-grey"></i>
                                <span><strong>Lưu</strong></span>
                            </a>
                            <a class="btn btn-app custom-btn disabled" data-toggle="tooltip" title="Hủy" data-placement="bottom">
                                <i class="fa fa-close text-grey"></i>
                                <span><strong>Hủy</strong></span>
                            </a>
                            <a class="btn btn-app custom-btn" data-toggle="modal" title="Thanh toán" data-target="#confirm-process" data-placement="bottom">
                                <i class="fa fa-check-circle text-green"></i>
                                <span><strong>Thanh toán</strong></span>
                            </a>
                            <a class="btn btn-app custom-btn disabled" data-toggle="tooltip" title="Xử Lý" data-placement="bottom">
                                <i class="fa fa-exchange text-grey"></i>
                                <span><strong>Đổi trả</strong></span>
                            </a>
                            <a class="btn btn-app custom-btn disabled" data-toggle="tooltip" title="Xem trước" data-placement="bottom">
                                <i class="fa fa-eye text-grey"></i>
                                <span><strong>Xem trước</strong></span>
                            </a>
                            <a class="btn btn-app custom-btn disabled" data-toggle="tooltip" title="In" data-placement="bottom">
                                <i class="fa fa-print text-grey"></i>
                                <span><strong>In</strong></span>
                            </a>
                            <a class="btn btn-app custom-btn disabled" data-toggle="tooltip" title="Import Excel" data-placement="bottom">
                                <i class="fa fa-download text-grey"></i>
                                <span><strong>Import Excel</strong></span>
                            </a>
                            <a class="btn btn-app custom-btn disabled" data-toggle="tooltip" title="Tải xuống dưới dạng Excel" data-placement="bottom">
                                <i class="fa fa-file-excel-o text-grey"></i>
                                <span><strong>Xuất Excel</strong></span>
                            </a>
                            <a class="btn btn-app custom-btn disabled" data-toggle="tooltip" title="Tải xuống dưới dạng PDF" data-placement="bottom">
                                <i class="fa fa-file-pdf-o text-grey"></i>
                                <span><strong>Xuất PDF</strong></span>
                            </a>
                        </div>
                    </div>


                    <div class="box-body">
                        <hr />
                        <div class="row">
                            <div class="col-md-offset-2" style="display: inline-flex; margin-bottom: 20px;">
                                <label style="padding-left:15px;padding-right: 10px; padding-top: 10px;">Từ: </label>
                                <div class="input-group week-select col-md-4">
                                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                    <input type="text" class="form-control datepicker" id="fromDate">
                                </div>
                                <label style="padding-left:15px;padding-right: 10px; padding-top: 10px;">Đến: </label>
                                <div class="input-group week-select col-md-4">
                                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                    <input type="text" class="form-control datepicker" id="toDate">
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="box-body">
                            <table id="example1" class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th style="width: 2%">Ngày</th>
                                        <th style="width: 4%">Số PO</th>
                                        <th style="width: 7%">Diễn giải</th>
                                        <th style="width: 5%">Tiền hàng</th>
                                        <th style="width: 5%">Thanh toán</th>
                                        <th style="width: 4%">Dư nợ</th>
                                        <th style="width: 3%">Ghi chú</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.lstDisplay.Count() == 0)
                                    {
                                        <tr>
                                            <td colspan="7" style="font-size:17px">Không tìm thấy bản ghi nào!</td>
                                        </tr>
                                    }
                                    else
                                    {
                                        int i = 1;
                                        foreach (var item in Model.lstDisplay)
                                        {
                                            <tr>
                                                <td class="length">@item.ngay</td>
                                                <td>@item.soPo</td>
                                                <td>@item.dienGiai</td>
                                                <td class="right number" id="tienHang_@i">@item.tienHang</td>
                                                <td class="right number" id="thanhToan_@i">@item.thanhToan</td>
                                                <td class="text-right number" id="duNo_@i">@item.duNo</td>
                                                <td class="right number"></td>
                                            </tr>
                                            i++;
                                        }
                                    }

                                </tbody>
                                <tfoot>
                                    @if (Model.lstDisplay.Count() != 0)
                                    {
                                        <tr>
                                            <td colspan="3" style="font-weight: bold;text-align: center">Tổng</td>
                                            <td style="font-weight: bold" class="number text-right" id="tienHang"></td>
                                            <td style="font-weight: bold" class="number text-right" id="thanhToan"></td>
                                            <td style="font-weight: bold" class="number text-right" id="duNo"></td>
                                            <td style="font-weight: bold"></td>
                                        </tr>
                                    }
                                </tfoot>
                            </table>
                            <!-- Modal -->
                            <div class="modal fade" id="confirm-process" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                <!-- Modal content-->
                                <div class="modal-dialog">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                                        <h4 class="modal-title"><b>Thanh Toán Công nợ</b></h4>
                                    </div>
                                    <div class="modal-body">
                                        <p id="msgs" style="font-size:17px;margin-left:20%;color:red"></p>
                                        <table style="margin-left:20%;height:400px">
                                            <tr>
                                                <td><i class="fa fa-calendar"><b>  Ngày: </b></td>
                                                <td style="padding-left:15px;width:250px"><input type="text" id="datepicker" class="form-control" /></td>
                                            </tr>
                                            <tr>
                                                <td><i class="fa fa-edit"><b>  Diễn giải: </b></i></td>
                                                <td style="padding-left:15px;width:250px">@Html.TextAreaFor(model => model.dienGiai, new { @class = "form-control", @id = "dienGiai1" })</td>
                                            </tr>
                                            <tr>
                                                <td><i class="fa fa-money"><b>  Nợ cũ: </b></i></td>
                                                <td style="padding-left:15px;width:250px">@Html.TextBoxFor(model => model.lastedDebt, new { @class = "form-control number", @id = "noCu1", @readonly = "readonly" })</td>
                                            <tr>
                                            <tr>
                                                <td><i class="fa fa-money"><b>  Tiền hàng: </b></i></td>
                                                <td style="padding-left:15px;width:250px">@Html.TextBoxFor(model => model.tienHang, new { @class = "form-control number", @id = "tienHang1" })</td>

                                            <tr>
                                                <td><i class="fa fa-money"><b>  Thanh toán: </b></i></td>
                                                <td style="padding-left:15px;width:250px">@Html.TextBoxFor(model => model.thanhToan, new { @id = "thanhToan1", @class = "form-control number" })</td>
                                            </tr>
                                            <tr>
                                                <td><i class="fa fa-money"><b>  Dư nợ: </b></i></td>
                                                <td style="padding-left:15px;width:250px">@Html.TextBoxFor(model => model.duNo, new { @id = "duNo1", @class = "form-control number", @readonly = "readonly" })</td>
                                            </tr>
                                            <tr>
                                                <td><i class="fa fa-edit"><b>  Ghi chú: </b></i></td>
                                                <td style="padding-left:15px;width:250px">@Html.TextAreaFor(model => model.ghiChu, new { @id = "ghiChu1", @class = "form-control" })</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" style="color:white;background-color:green" class="btn btn-default" onclick="validateData(); return false;">Thêm</button>
                                        <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                                    </div>
                                </div>
                            </div>
                            <!--popup confirm-->
                            <div class="modal fade" id="popupConfirm" role="dialog">
                                <div class="modal-dialog" style="width:250px;height:150px">

                                    <!-- Modal content-->
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                                            <h4 class="modal-title">Xác nhận thêm công nợ mới</h4>
                                        </div>
                                        <div class="modal-body">
                                            <table>
                                                <tr>
                                                    <td>Bạn có muốn thêm công nợ mới?</td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="modal-footer" style="margin-right:15px">
                                            <button id="btnThanhToan" type="button" style="color:white;background-color:green" class="btn btn-default">Xác nhận</button>
                                            <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </section>
    @section Index{
        <script src="/Assets/dist/js/sweetalert2.all.js"></script>
        <script src="~/Assets/dist/js/bootstrap-datepicker.js"></script>
        <script src="~/Assets/dist/js/autoNumeric.js"></script>
        <script src="~/Assets/dist/js/autoNumeric.min.js"></script>
        <script>
            $(document).ready(function () {
                tinhTong();
                init();
            });
            function init() {
                $("#hidden").hide();
                $(".number").autoNumeric('init', { minimumValue: '1', maximumValue: '9999999999999', digitGroupSeparator: ',', mDec: '0' });
                $("#datepicker").datepicker({
                    format: 'dd/mm/yyyy'
                });
            }

            $.datepicker.setDefaults({
                changeMonth: true,
                changeYear: true,
                dateFormat: 'dd/mm/yy'
            });
            $('#fromDate').datepicker({
                minDate: '+0',
                onSelectDate: function (dateStr) {
                    var min = $(this).datepicker('getDate') || new Date(); // Selected date or today if none
                    var max = new Date(min.getTime());
                    max.setMonth(max.getMonth() + 1); // Add one month
                    $('#toDate').datepicker('option', { minDate: min, maxDate: max });
                }
            });
            $('#toDate').datepicker({
                minDate: '+0',
                maxDate: '+1m',
                onSelectDate: function (dateStr) {
                    var max = $(this).datepicker('getDate'); // Selected date or null if none
                    $('#fromDate').datepicker('option', { maxDate: max });
                }
            });

            function tinhTong() {
                var tienHang = 0;
                var thanhToan = 0;
                var duNo = 0;
                for (var i = 1; i <= $('.length').length; i++) {
                    tienHang += parseFloat($("#tienHang_" + i).text().replace(/,/g, ''));
                    thanhToan += parseFloat($("#thanhToan_" + i).text().replace(/,/g, ''));
                    duNo += parseFloat($("#duNo_" + i).text().replace(/,/g, ''));
                }
                $("#tienHang").text(tienHang);
                $("#thanhToan").text(thanhToan);
                $("#duNo").text(duNo);
            }

            function validateData() {
                var msgs = "";
                var ngay = $("#datepicker").val();
                var tienHang = $("#tienHang1").val();
                var thanhToan = $("#thanhToan1").val();
                var noCu = $("#noCu1").val();

                if (!ngay) {
                    msgs += "Vui lòng nhập ngày!<br/>";
                }
                if (!tienHang) {
                    msgs += "Vui lòng nhập tiền hàng!<br/>";
                }
                if (!thanhToan) {
                    msgs += "Vui lòng nhập thanh toán!<br/>"
                }
                if (msgs != "") {
                    $("#msgs").html(msgs);
                }
                else {
                    $("#popupConfirm").modal("show");
                }
                $("#btnThanhToan").click(function (event) {
                    event.preventDefault();
                    $.ajax({
                        type: "POST",
                        url: '/ChiTietNoCungCap/InsertData',
                        dataType: "JSON",
                        data: {
                            supplierId: $("#hidden").text(),
                            ngay: $("#datepicker").val(),
                            dienGiai: $("#dienGiai1").val(),
                            noCu: $("#noCu1").val().replace(/,/g, ''),
                            tienHang: $("#tienHang1").val().replace(/,/g, ''),
                            thanhToan: $("#thanhToan1").val().replace(/,/g, ''),
                            duNo: $("#duNo1").val().replace(/,/g, ''),
                            ghiChu: $("#ghiChu").val()
                        },
                        success: function () {
                            swal({
                                title: '<img src="/Assets/dist/img/messagePic_2.png"/>',
                                type: 'success',
                                timer: 5000,
                                showConfirmButton: true
                            }).then((result) => {
                                if (result.value) {
                                    window.location.reload();
                                }
                            });
                        }
                    });
                });
            }
            $("#thanhToan1, #tienHang1").change(function () {
                calculate();
            });
            function calculate() {
                var noCu = parseFloat($("#noCu1").val().replace(/,/g, ''));
                var thanhToan = $("#thanhToan1").val().replace(/,/g, '');
                var tienHang = $("#tienHang1").val().replace(/,/g, '');
                var duNo = 0;

                if (!thanhToan) {
                    thanhToan = 0;
                }
                if (!tienHang) {
                    tienHang = 0;
                }
                duNo = (noCu + parseFloat(tienHang)) - parseFloat(thanhToan);
                $("#duNo1").val(duNo.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                init();
            }
        </script>
    }
}